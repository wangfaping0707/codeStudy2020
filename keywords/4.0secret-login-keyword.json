[
  {
    "name": "4.0client的token",
    "keywords": [
      {
        "name": "获取4.0client登录token",
        "doc": "4.0登录，针对于多用户存储${token}全局变量，${token}里存字典，key是client_id,value是4.0登录的token信息",
        "args": [
          "${login_url}",
          "${client_id}",
          "${secret}"
        ],
        "steps": [
          {
            "name": "初始化sql",
            "type": "mysql-update",
            "config": "${数据库配置}",
            "sql": [
              "delete from sys_resourceset where app_id not in (select app_id from bss_app)",
              "delete from sys_org_struct where tenant_id not in (select tenant_id from bss_tenant)",
              "delete from sys_org_user_rel where user_id not in (select user_id from sys_user)",
              "delete from sys_org_user_rel where tenant_id not in (select tenant_id from bss_tenant)",
              "delete from sys_user where tenant_id not in (select tenant_id from bss_tenant)",
              "delete from sys_user where account_id not in (select account_id from sys_sass_account)",
              "delete from bss_tenant_secret where tenant_id not in (select tenant_id from bss_tenant)",
              "delete from sys_role where tenant_id not in (select tenant_id from bss_tenant) and tenant_id >0",
              "delete from sys_role_resourceset_rel where role_id not in (select role_id from sys_role)",
              "delete from sys_role_resourceset_rel where resouseset_id not in (select resourceset_id from sys_resourceset)",
              "delete from sys_resourceset_resource_rel where resourceset_id not in (select resourceset_id from sys_resourceset)",
              "delete from sys_resourceset_resource_rel where resource_id not in (select resource_id from sys_resource)",
              "delete from bss_service_resourceset_rel where service_package_id not in (select service_package_id from bss_service_package)",
              "delete from bss_service_resourceset_rel where resourceset_id not in (select resourceset_id from sys_resourceset)",
              "delete from sys_resource_api_rel where resource_id not in (select resource_id from sys_resource)",
              "delete from sys_resource_api_rel where service_api_id not in (select service_api_id from sys_service_api)",
              "delete from sys_role_user_rel where role_id not in (select role_id from sys_role)",
              "delete from sys_role_user_rel where user_id not in (select user_id from sys_user)",
              "delete from sys_sass_account where account_id not in (select account_id from sys_user)",
              "delete from sys_user_tag where user_id not in (select user_id from sys_user)",
              "update sys_org_struct set tenant_id = null where tenant_id not in (select tenant_id from bss_tenant)",
              "update sys_org_struct set company_id = null where company_id not in (select company_id from bss_company)"
            ]
          },
          {
            "name": "登录",
            "type": "python",
            "path": "atApiXforce4Login/xforce4login.py",
            "keyword": "at_xforce4_client_login",
            "params": [
              "${login_url}",
              "${client_id}",
              "${secret}"
            ]
          },
          {
            "name": "用户token",
            "type": "rft",
            "keyword": "create dictionary",
            "params": [
              "${client_id}",
              "${登录}"
            ]
          },
          {
            "name": "验证token是否存在",
            "type": "rft",
            "keyword": "run keyword and continue on failure",
            "params": [
              "get variable value",
              "${token}"
            ]
          },
          {
            "name": "设置global变量",
            "type": "rft",
            "keyword": "run keyword unless",
            "params": [
              "${验证token是否存在}",
              "set global variable",
              "${token}",
              "${用户token}"
            ]
          },
          {
            "name": "获取token变量",
            "type": "rft",
            "keyword": "run keyword if",
            "params": [
              "${验证token是否存在}",
              "get variable value",
              "${token}"
            ]
          },
          {
            "name": "更新token",
            "type": "rft",
            "keyword": "run keyword if",
            "params": [
              "${验证token是否存在}",
              "set to dictionary",
              "${token}",
              "${client_id}",
              "${登录}"
            ]
          },
          {
            "name": "设置global变量",
            "type": "rft",
            "keyword": "run keyword if",
            "params": [
              "${验证token是否存在}",
              "set global variable",
              "${token}"
            ]
          }
        ]
      },
      {
        "name": "获取secret_token",
        "args": [
          "${login_url}",
          "${client_id}",
          "${secret}"
        ],
        "steps": [
          {
            "name": "验证token是否存在",
            "type": "rft",
            "keyword": "run keyword and continue on failure",
            "params": [
              "get variable value",
              "${token}"
            ]
          },
          {
            "name": "如果token不存在登录",
            "type": "rft",
            "keyword": "run keyword unless",
            "params": [
              "${验证token是否存在}",
              "获取4.0client登录token",
              "${login_url}",
              "${client_id}",
              "${secret}"
            ]
          },
          {
            "name": "如果token存在,验证client_id是否存在",
            "type": "rft",
            "keyword": "run keyword if",
            "params": [
              "${验证token是否存在}",
              "evaluate",
              "'${client_id}' in ${token}"
            ]
          },
          {
            "name": "如果token里的用户不存在就登录",
            "type": "rft",
            "keyword": "run keyword unless",
            "params": [
              "${如果token存在,验证client_id是否存在}",
              "获取4.0client登录token",
              "${login_url}",
              "${client_id}",
              "${secret}"
            ]
          }
        ]
      }
    ]
  }
]